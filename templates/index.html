<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clownfish Egg Counter</title>
<meta name="description" content="Count clownfish eggs instantly using computer vision. Upload a photo, get a count — entirely in your browser.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}

:root{
  --bg:#faf9f7;
  --surface:#ffffff;
  --surface-2:#f5f3f0;
  --border:#eae7e2;
  --border-focus:#d4d0c9;
  --ink:#1a1816;
  --ink-2:#5c5650;
  --ink-3:#9c9590;
  --ink-4:#bfb9b2;
  --coral:#e05a24;
  --coral-dim:#f2ddd0;
  --coral-wash:#fdf5f0;
  --serif:'Instrument Serif', Georgia, serif;
  --sans:'DM Sans', system-ui, -apple-system, sans-serif;
  --ease:cubic-bezier(.4,0,.2,1);
}

html{scroll-behavior:smooth}
body{font-family:var(--sans);background:var(--bg);color:var(--ink);-webkit-font-smoothing:antialiased;min-height:100vh}

/* ─── Layout ─── */
.page{max-width:660px;margin:0 auto;padding:72px 24px 120px}
@media(max-width:480px){.page{padding:48px 16px 80px}}

/* ─── Header ─── */
.head{text-align:center;margin-bottom:48px}
.chip{
  display:inline-flex;align-items:center;gap:6px;
  font-size:.73rem;font-weight:600;letter-spacing:.06em;text-transform:uppercase;
  color:var(--coral);background:var(--coral-wash);
  padding:6px 14px;border-radius:99px;margin-bottom:20px;
}
.chip svg{width:14px;height:14px}
h1{font-family:var(--serif);font-size:clamp(2.2rem,6vw,3rem);font-weight:400;line-height:1.1;letter-spacing:-.02em;margin-bottom:10px}
.lead{font-size:.95rem;color:var(--ink-2);line-height:1.6;max-width:440px;margin:0 auto}

/* ─── Notice ─── */
.notice{
  display:flex;gap:10px;align-items:flex-start;
  padding:14px 16px;margin-bottom:32px;
  background:var(--coral-wash);border-radius:10px;
  font-size:.82rem;color:var(--ink-2);line-height:1.55;
}
.notice svg{flex-shrink:0;width:18px;height:18px;color:var(--coral);margin-top:1px}

/* ─── Card ─── */
.card{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;transition:border-color .2s var(--ease)}

/* ─── Upload zone ─── */
.zone{padding:56px 32px;text-align:center;cursor:pointer;position:relative;transition:background .2s var(--ease)}
.zone:hover{background:var(--surface-2)}
.zone.over{background:var(--coral-wash)}
.zone input{position:absolute;inset:0;opacity:0;cursor:pointer}
.zone-ring{
  display:inline-flex;align-items:center;justify-content:center;
  width:56px;height:56px;border-radius:16px;
  background:var(--surface-2);border:1px solid var(--border);
  margin-bottom:16px;transition:border-color .2s var(--ease),background .2s var(--ease);
}
.zone:hover .zone-ring{border-color:var(--border-focus);background:var(--bg)}
.zone-ring svg{width:24px;height:24px;color:var(--ink-3);transition:color .2s var(--ease)}
.zone:hover .zone-ring svg{color:var(--ink-2)}
.zone-t{font-size:.92rem;font-weight:500;color:var(--ink);margin-bottom:3px}
.zone-h{font-size:.8rem;color:var(--ink-4)}

/* ─── File bar ─── */
.fbar{display:none;align-items:center;gap:12px;padding:14px 18px;border-top:1px solid var(--border)}
.fbar.on{display:flex}
.fbar img{width:40px;height:40px;border-radius:8px;object-fit:cover;border:1px solid var(--border)}
.fbar-info{flex:1;min-width:0}
.fbar-name{font-size:.84rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.fbar-size{font-size:.74rem;color:var(--ink-4)}
.fbar-x{
  display:flex;align-items:center;justify-content:center;
  width:28px;height:28px;border-radius:6px;
  background:none;border:none;cursor:pointer;
  color:var(--ink-4);transition:background .15s,color .15s;
}
.fbar-x:hover{background:var(--surface-2);color:var(--ink-2)}
.fbar-x svg{width:14px;height:14px}

/* ─── Go button ─── */
.go-bar{display:none;padding:14px 18px;border-top:1px solid var(--border)}
.go-bar.on{display:block}
.go{
  width:100%;padding:12px;border:none;border-radius:10px;
  font-family:var(--sans);font-size:.9rem;font-weight:600;
  color:#fff;background:var(--coral);cursor:pointer;
  transition:opacity .15s var(--ease),transform .1s var(--ease);
}
.go:hover:not(:disabled){opacity:.9}
.go:active:not(:disabled){transform:scale(.99)}
.go:disabled{opacity:.35;cursor:default}

/* ─── Processing ─── */
.proc{display:none;padding:56px 32px;text-align:center}
.proc.on{display:block}
.proc-bar{width:180px;height:3px;background:var(--border);border-radius:3px;margin:0 auto 18px;overflow:hidden}
.proc-fill{height:100%;width:30%;background:var(--coral);border-radius:3px;animation:slide 1s var(--ease) infinite}
@keyframes slide{0%{transform:translateX(-100%)}100%{transform:translateX(700%)}}
.proc-t{font-size:.88rem;color:var(--ink-2)}
.proc-s{font-size:.76rem;color:var(--ink-4);margin-top:4px}

/* ─── Results ─── */
.out{display:none;opacity:0;transform:translateY(8px);transition:opacity .4s var(--ease),transform .4s var(--ease)}
.out.on{display:block}
.out.vis{opacity:1;transform:translateY(0)}

.hero{text-align:center;padding:44px 20px;background:var(--surface);border:1px solid var(--border);border-radius:16px;margin-bottom:16px}
.hero-label{font-size:.7rem;text-transform:uppercase;letter-spacing:.12em;color:var(--ink-4);font-weight:600;margin-bottom:6px}
.hero-num{font-family:var(--serif);font-size:clamp(3.5rem,12vw,5.5rem);line-height:1;color:var(--coral);letter-spacing:-.03em}
.hero-unit{font-size:.88rem;color:var(--ink-3);margin-top:4px}

/* ─── Tabs ─── */
.tcard{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:16px}
.trow{display:flex;border-bottom:1px solid var(--border)}
.tbtn{
  flex:1;padding:12px 4px;background:none;border:none;
  font-family:var(--sans);font-size:.8rem;font-weight:500;
  color:var(--ink-4);cursor:pointer;position:relative;
  transition:color .2s var(--ease);
}
.tbtn:hover{color:var(--ink-2)}
.tbtn::after{content:'';position:absolute;bottom:-1px;left:20%;right:20%;height:2px;background:var(--coral);border-radius:2px;transform:scaleX(0);transition:transform .2s var(--ease)}
.tbtn.on{color:var(--coral)}
.tbtn.on::after{transform:scaleX(1)}
.tpanel{display:none;padding:10px}
.tpanel.on{display:block}
.tpanel canvas{width:100%;border-radius:10px;display:block}
.tpanel p{font-size:.74rem;color:var(--ink-4);padding:8px 2px 2px}

.back-row{text-align:center;margin-top:10px}
.back{
  background:none;border:1px solid var(--border);border-radius:10px;
  padding:10px 24px;font-family:var(--sans);font-size:.85rem;font-weight:500;
  color:var(--ink-2);cursor:pointer;transition:all .15s var(--ease);
}
.back:hover{border-color:var(--border-focus);color:var(--ink)}

/* ─── Method ─── */
.method{margin-top:44px}
.method summary{
  font-family:var(--serif);font-size:1.1rem;cursor:pointer;
  list-style:none;display:flex;align-items:center;gap:8px;
  color:var(--ink);padding:0 2px;
}
.method summary::-webkit-details-marker{display:none}
.method summary svg{width:16px;height:16px;color:var(--ink-3);transition:transform .2s var(--ease)}
.method[open] summary svg{transform:rotate(180deg)}
.method-body{
  margin-top:16px;padding:22px;
  background:var(--surface);border:1px solid var(--border);border-radius:14px;
}
.st{display:flex;gap:10px;padding:8px 0}
.st:first-child{padding-top:0}
.st:last-child{padding-bottom:0}
.st+.st{border-top:1px solid var(--border)}
.st-n{
  flex-shrink:0;width:22px;height:22px;border-radius:7px;
  background:var(--coral-wash);color:var(--coral);
  font-size:.68rem;font-weight:700;
  display:flex;align-items:center;justify-content:center;margin-top:2px;
}
.st p{font-size:.84rem;color:var(--ink-2);line-height:1.55}
.st strong{color:var(--ink);font-weight:500}

footer{text-align:center;margin-top:52px;font-size:.74rem;color:var(--ink-4);line-height:1.7}

.cv-msg{text-align:center;padding:8px;font-size:.76rem;color:var(--ink-4);display:none}
.cv-msg.on{display:block}
</style>
</head>
<body>
<div class="page">

  <header class="head">
    <div class="chip">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12c2-4 6-7 10-7s8 3 10 7c-2 4-6 7-10 7s-8-3-10-7z"/><circle cx="12" cy="12" r="3"/></svg>
      Computer Vision
    </div>
    <h1>Clownfish Egg Counter</h1>
    <p class="lead">Upload a photo of clownfish eggs and get an instant count — processed entirely in your browser.</p>
  </header>

  <div class="notice">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><circle cx="12" cy="16" r=".5" fill="currentColor"/></svg>
    <div>This tool uses <strong>classical computer vision</strong> (bandpass filtering), not a trained deep learning model. Counts are estimates from a single image and may have errors in dense clusters or poor lighting.</div>
  </div>

  <!-- Upload -->
  <div class="card" id="uCard">
    <div class="zone" id="zone">
      <div class="zone-ring">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      </div>
      <div class="zone-t">Drop your image here or click to browse</div>
      <div class="zone-h">JPG or PNG</div>
      <input type="file" id="fin" accept="image/*">
    </div>
    <div class="fbar" id="fbar">
      <img id="thumb">
      <div class="fbar-info"><div class="fbar-name" id="fname"></div><div class="fbar-size" id="fsize"></div></div>
      <button class="fbar-x" id="xbtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="go-bar" id="goBar"><button class="go" id="goBtn" disabled>Count Eggs</button></div>
    <div class="proc" id="proc"><div class="proc-bar"><div class="proc-fill"></div></div><div class="proc-t">Analyzing image…</div><div class="proc-s">All processing happens locally in your browser</div></div>
  </div>
  <div class="cv-msg" id="cvMsg">Loading OpenCV.js…</div>

  <!-- Results -->
  <div class="out" id="out">
    <div class="hero">
      <div class="hero-label">Estimated Count</div>
      <div class="hero-num" id="num">0</div>
      <div class="hero-unit">eggs detected</div>
    </div>
    <div class="tcard">
      <div class="trow">
        <button class="tbtn on" data-t="ov">Detection</button>
        <button class="tbtn" data-t="bp">Bandpass</button>
        <button class="tbtn" data-t="mk">Mask</button>
      </div>
      <div class="tpanel on" id="t-ov"><canvas id="cOv"></canvas><p>Green dot on each detected egg center</p></div>
      <div class="tpanel" id="t-bp"><canvas id="cBp"></canvas><p>Difference-of-Gaussians isolates egg-sized features</p></div>
      <div class="tpanel" id="t-mk"><canvas id="cMk"></canvas><p>HSV color segmentation of orange egg pixels</p></div>
    </div>
    <div class="back-row"><button class="back" id="again">Try another image</button></div>
  </div>

  <!-- Method -->
  <details class="method">
    <summary>How it works <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg></summary>
    <div class="method-body">
      <div class="st"><div class="st-n">1</div><p><strong>Color filter</strong> — HSV thresholding isolates orange egg pixels from the tile background</p></div>
      <div class="st"><div class="st-n">2</div><p><strong>Bandpass filter</strong> — Difference of Gaussians on the LAB A-channel highlights individual egg-sized features, even in dense clusters</p></div>
      <div class="st"><div class="st-n">3</div><p><strong>Peak detection</strong> — Non-maximum suppression finds one intensity peak per egg center</p></div>
      <div class="st"><div class="st-n">4</div><p><strong>Validation</strong> — Saturation and color checks at each candidate reject false positives on tile gaps</p></div>
    </div>
  </details>

  <footer>Runs 100% in your browser · No images uploaded to any server<br>Built with OpenCV.js · Classical computer vision</footer>
</div>

<script>
let file = null;
const $ = (id) => document.getElementById(id);

/* ── UI ── */
const zone = $('zone'), fin = $('fin'), fb = $('fbar'), gb = $('goBar');

zone.ondragover = e => { e.preventDefault(); zone.classList.add('over') };
zone.ondragleave = () => zone.classList.remove('over');
zone.ondrop = e => { e.preventDefault(); zone.classList.remove('over'); e.dataTransfer.files[0] && pick(e.dataTransfer.files[0]) };
fin.onchange = e => e.target.files[0] && pick(e.target.files[0]);
$('xbtn').onclick = clear;
$('again').onclick = () => { $('out').classList.remove('on','vis'); $('uCard').style.display=''; clear(); };
$('goBtn').onclick = run;

document.querySelectorAll('.tbtn').forEach(b => b.onclick = () => {
  document.querySelectorAll('.tbtn').forEach(x => x.classList.remove('on'));
  document.querySelectorAll('.tpanel').forEach(x => x.classList.remove('on'));
  b.classList.add('on'); $('t-' + b.dataset.t).classList.add('on');
});

function pick(f){
  if(!f.type.startsWith('image/')) return;
  file = f;
  const r = new FileReader();
  r.onload = e => {
    $('thumb').src = e.target.result;
    $('fname').textContent = f.name;
    $('fsize').textContent = (f.size/1048576).toFixed(1) + ' MB';
    fb.classList.add('on'); gb.classList.add('on'); zone.style.display='none';
    $('goBtn').disabled = false;
  };
  r.readAsDataURL(f);
}
function clear(){
  file=null; fin.value='';
  fb.classList.remove('on'); gb.classList.remove('on');
  zone.style.display='';
  $('proc').classList.remove('on');
  $('goBtn').disabled = true;
}

async function run(){
  if(!file) return;

  zone.style.display='none';
  fb.classList.remove('on'); gb.classList.remove('on');
  $('proc').classList.add('on');

  try{
    const fd = new FormData();
    fd.append('image', file);

    const resp = await fetch('/analyze', { method:'POST', body: fd });
    const data = await resp.json();

    if(!resp.ok){
      throw new Error(data.error || ('HTTP ' + resp.status));
    }

    $('proc').classList.remove('on');
    show({
      count: data.count ?? 0,
      overlay: data.overlay ? ('data:image/png;base64,' + data.overlay) : null,
      bandpass: data.bandpass ? ('data:image/png;base64,' + data.bandpass) : null,
      mask: data.mask ? ('data:image/png;base64,' + data.mask) : null,
    });
  }catch(err){
    $('proc').classList.remove('on');
    alert('Error: ' + err.message);
    console.error(err);
    gb.classList.add('on');
    fb.classList.add('on');
  }
}

function show(res){
  $('uCard').style.display='none';

  const o = $('out');
  o.classList.add('on');
  requestAnimationFrame(() => requestAnimationFrame(() => o.classList.add('vis')));

  anim($('num'), res.count);

  // Draw backend images into canvases
  if(res.overlay) drawToCanvas(res.overlay, $('cOv'));
  if(res.bandpass) drawToCanvas(res.bandpass, $('cBp'));
  if(res.mask) drawToCanvas(res.mask, $('cMk'));

  document.querySelectorAll('.tbtn')[0].click();
}

function anim(el, n){
  const t0 = performance.now();
  (function f(now){
    const p = Math.min((now - t0)/900, 1);
    el.textContent = Math.round(n * (1 - Math.pow(1 - p, 3)));
    if(p < 1) requestAnimationFrame(f);
  })(t0);
}

function drawToCanvas(src, canvas){
  const img = new Image();
  img.onload = () => {
    canvas.width = img.naturalWidth;
    canvas.height = img.naturalHeight;
    canvas.style.width = '100%';
    canvas.style.height = 'auto';
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img, 0, 0);
  };
  img.src = src;
}
</script>
</body>
</html>